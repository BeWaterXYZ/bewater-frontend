# 数据库迁移开发规范

## 目录
- [概述](#概述)
- [开发环境迁移](#开发环境迁移)
- [生产环境迁移](#生产环境迁移)
- [迁移文件命名规范](#迁移文件命名规范)
- [最佳实践](#最佳实践)
- [常见问题](#常见问题)

## 概述

本文档描述了在使用 Prisma 进行数据库迁移时的开发规范和最佳实践。数据库迁移是管理数据库架构变更的重要工具，需要谨慎处理以确保数据安全和系统稳定性。

## 开发环境迁移

### 创建新的迁移

当需要修改数据库架构时，请按以下步骤操作：

1. 修改 `prisma/schema.prisma` 文件
2. 运行以下命令创建迁移：
```bash
npx prisma migrate dev --name <migration_name>
```

这个命令会：
- 检测 schema 变更
- 创建新的迁移文件
- 应用迁移到开发数据库
- 重新生成 Prisma Client

### 重置开发数据库

如果需要重置开发数据库：
```bash
npx prisma migrate reset
```

注意：此命令会删除所有数据，仅用于开发环境。

## 生产环境迁移

### 部署迁移

将迁移应用到生产环境：
```bash
npx prisma migrate deploy
```

这个命令会：
- 应用所有未执行的迁移
- 不会修改 schema.prisma 文件
- 不会重新生成 Prisma Client

### 检查迁移状态

检查迁移状态：
```bash
npx prisma migrate status
```

## 迁移文件命名规范

迁移文件名应遵循以下格式：
```
YYYYMMDDHHMMSS_<descriptive_name>.sql
```

命名建议：
- 使用动词开头，如：add_, create_, modify_, remove_
- 使用下划线分隔单词
- 使用小写字母
- 名称应该清晰描述迁移的目的

例如：
```
20240325153441_add_sponsor_transaction.sql
20240325153906_add_project_info_to_sponsor_transaction.sql
```

## 最佳实践

### 1. 迁移前准备
- 在开发环境充分测试迁移
- 备份生产数据库
- 选择低峰期执行迁移

### 2. 迁移文件编写
- 每个迁移应该是幂等的
- 包含向上和向下迁移
- 添加适当的注释
- 使用事务包装迁移操作

### 3. 数据安全
- 避免在生产环境直接修改数据
- 使用事务确保数据一致性
- 保留回滚方案

### 4. 性能考虑
- 为大型表添加索引
- 避免在迁移中执行大量数据操作
- 考虑分批处理大量数据

### 5. 版本控制
- 将迁移文件纳入版本控制
- 不要修改已提交的迁移文件
- 保持迁移历史的完整性

## 常见问题

### 1. 迁移失败
如果迁移失败：
1. 检查错误信息
2. 回滚失败的迁移
3. 修复问题后重新执行迁移

### 2. 数据丢失
如果发生数据丢失：
1. 立即停止迁移
2. 使用备份恢复数据
3. 分析原因并修复问题

### 3. 性能问题
如果迁移导致性能问题：
1. 检查索引是否正确
2. 考虑分批处理数据
3. 优化查询语句

## 注意事项

1. 永远不要在生产环境使用 `prisma migrate dev`
2. 始终在应用迁移前备份数据库
3. 保持迁移文件的原子性
4. 记录所有迁移操作
5. 定期检查迁移历史

## 相关命令参考

```bash
# 创建迁移
npx prisma migrate dev --name <migration_name>

# 部署迁移
npx prisma migrate deploy

# 检查状态
npx prisma migrate status

# 重置数据库（仅开发环境）
npx prisma migrate reset

# 生成 Prisma Client
npx prisma generate
``` 